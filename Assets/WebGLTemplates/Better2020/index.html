<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>{{{ PRODUCT_NAME }}}</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <link rel="stylesheet" href="TemplateData/style.css" />
  </head>
  <body class="{{{ SPLASH_SCREEN_STYLE.toLowerCase() }}}">
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas"></canvas>
    </div>
    <div id="loading-cover" style="display: none">
      <div id="unity-loading-bar">
        <div id="unity-logo"><img src="logo.png" /></div>
        <div id="unity-progress-bar-empty" style="display: none">
          <div id="unity-progress-bar-full"></div>
        </div>
        <div class="spinner"></div>
      </div>
    </div>
    <div id="unity-fullscreen-button" style="display: none"></div>
    <script
      src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
      type="application/javascript"
    ></script>
    <script type="module">
            const hideFullScreenButton = "{{{ HIDE_FULL_SCREEN_BUTTON }}}";
            const buildUrl = "Build";
            const loaderUrl = buildUrl + "/{{{ LOADER_FILENAME }}}";
            const config = {
              dataUrl: buildUrl + "/{{{ DATA_FILENAME }}}",
              frameworkUrl: buildUrl + "/{{{ FRAMEWORK_FILENAME }}}",
              codeUrl: buildUrl + "/{{{ CODE_FILENAME }}}",
      #if MEMORY_FILENAME
              memoryUrl: buildUrl + "/{{{ MEMORY_FILENAME }}}",
      #endif
      #if SYMBOLS_FILENAME
              symbolsUrl: buildUrl + "/{{{ SYMBOLS_FILENAME }}}",
      #endif
              streamingAssetsUrl: "StreamingAssets",
              companyName: "{{{ COMPANY_NAME }}}",
              productName: "{{{ PRODUCT_NAME }}}",
              productVersion: "{{{ PRODUCT_VERSION }}}",
            };

            const container = document.querySelector("#unity-container");
            const canvas = document.querySelector("#unity-canvas");
            const loadingCover = document.querySelector("#loading-cover");
            const progressBarEmpty = document.querySelector("#unity-progress-bar-empty");
            const progressBarFull = document.querySelector("#unity-progress-bar-full");
            const fullscreenButton = document.querySelector("#unity-fullscreen-button");
            const spinner = document.querySelector('.spinner');

            const canFullscreen = (function() {
              for (const key of [
                  'exitFullscreen',
                  'webkitExitFullscreen',
                  'webkitCancelFullScreen',
                  'mozCancelFullScreen',
                  'msExitFullscreen',
                ]) {
                if (key in document) {
                  return true;
                }
              }
              return false;
            }());

            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
              container.className = "unity-mobile";
              config.devicePixelRatio = 1;
            }
      #if BACKGROUND_FILENAME
            canvas.style.background = "url('" + buildUrl + "/{{{ BACKGROUND_FILENAME.replace(/'/g, '%27') }}}') center / cover";
      #endif
            loadingCover.style.display = "";

            /// --- Thirdweb Brige ---
            import { ThirdwebSDK } from "https://esm.sh/@thirdweb-dev/sdk@nightly?bundle"
            // import { ethers } from "https://cdn.ethers.io/lib/ethers-5.2.esm.min.js";
            // big number transform
            const bigNumberReplacer = (key, value) => {
              // if we find a BigNumber then make it into a string (since that is safe)
              if (ethers.BigNumber.isBigNumber(value) ||
                (typeof value === "object" &&
                  value !== null &&
                  value.type === "BigNumber" &&
                  "hex" in value)
              ) {
                return ethers.BigNumber.from(value).toString();
              }
              return value;
            };

            const w = window;
            w.bridge = {};
            w.bridge.initialize = (chain, options) => {
              console.log("bridge.initialize", chain, options);
              const sdk = new ThirdwebSDK(chain, JSON.parse(options));
              w.thirdweb = sdk;
            }

            w.bridge.connect = async () => {
              if(w.ethereum) {
                await w.ethereum.enable
                const provider = new ethers.providers.Web3Provider(w.ethereum);
                await provider.send("eth_requestAccounts", []);
                const signer = provider.getSigner()
                if(w.thirdweb) {
                  console.log("connecting SDK");
                  w.thirdweb.updateSignerOrProvider(signer);
                  return await w.thirdweb.wallet.getAddress();
                } else {
                  console.error("window.thirdweb is not defined");
                  return null;
                }
              } else {
                console.error("Please install a wallet browser extension");
                return null;
              }
            }

            w.bridge.invoke = async (route, payload) => {
              const routeArgs = route.split(".")
              const firstArg = routeArgs[0].split("#");
              const addr = firstArg[0];
              let type = undefined;
              if(firstArg.length > 1) {
                type = firstArg[1];
              }
              const contract = await w.thirdweb.getContract(addr, type);
              const fnArgs = JSON.parse(payload).arguments;
              const parsedArgs = fnArgs.map((arg) => {
                try {
                  return JSON.parse(arg);
                } catch (e) {
                  return arg;
                }
              });
              console.log("invoke called", route, parsedArgs);
              if(routeArgs.length === 2) {
                // TODO assumes contract call
                const result = await contract[routeArgs[1]](...parsedArgs)
                return JSON.stringify({ result: result }, bigNumberReplacer);
              } else if(routeArgs.length === 3) {
                const result = await contract[routeArgs[1]][routeArgs[2]](...parsedArgs)
                return JSON.stringify({ result: result }, bigNumberReplacer);
              } else if(routeArgs.length === 4) {
                const result = await contract[routeArgs[1]][routeArgs[2]][routeArgs[3]](...parsedArgs)
                return JSON.stringify({ result: result }, bigNumberReplacer);
              }else {
                console.error("invalid route", route);
                return null;
              }
            };
            /// --- End Thirdweb Brige ---

            const script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
              createUnityInstance(canvas, config, (progress) => {
                spinner.style.display = "none";
                progressBarEmpty.style.display = "";
                progressBarFull.style.width = `${100 * progress}%`;
              }).then((unityInstance) => {
                loadingCover.style.display = "none";
                if (canFullscreen) {
                  if (!hideFullScreenButton) {
                    fullscreenButton.style.display = "";
                  }
                  fullscreenButton.onclick = () => {
                    unityInstance.SetFullscreen(1);
                  };
                }
              }).catch((message) => {
                alert(message);
              });
            };
            document.body.appendChild(script);
    </script>
  </body>
</html>
